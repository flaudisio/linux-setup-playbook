---
- name: Ensure directories of configuration files exist
  ansible.builtin.file:
    path: "{{ expanded_path | dirname }}"
    state: directory
    owner: "{{ item.owner | default(omit) }}"
    group: "{{ item.group | default(omit) }}"
  loop: "{{ dotfiles_extra_files }}"
  loop_control:
    label: "{{ item.path | dirname }}"
  vars:
    expanded_path: "{{ item.path | expanduser }}"
    path_in_home_dir: "{{ '/home/' in expanded_path }}"
  become: "{{ item.become | default(not path_in_home_dir) }}"

- name: Ensure configuration files exist
  ansible.builtin.copy:
    content: "{{ item.content }}"
    dest: "{{ expanded_path }}"
    owner: "{{ item.owner | default(omit) }}"
    group: "{{ item.group | default(omit) }}"
    mode: "{{ item.mode | default(omit) }}"
  loop: "{{ dotfiles_extra_files }}"
  loop_control:
    label: "{{ item.path }}"
  vars:
    expanded_path: "{{ item.path | expanduser }}"
    path_in_home_dir: "{{ '/home/' in expanded_path }}"
  become: "{{ item.become | default(not path_in_home_dir) }}"
